class Bank{constructor(e){this.clients=e}async getCurrencyRates(){let e,t=await fetch("https://api.privatbank.ua/p24api/pubinfo?json&exchange&coursid=5"),n={};t.ok&&(e=await t.json());for(let t=0;t<e.length;t++)n[e[t].ccy]=Number(e[t].sale);return n}get getClients(){return this.clients}async calcMoney(e){let t=await this.getCurrencyRates(),n={UAH:0,[e.toUpperCase()]:0};for(let e=0;e<this.clients.length;e++)for(let t=0;t<this.clients[e].accounts.length;t++){let i=this.clients[e].accounts[t];void 0===n[this.currencyTypes[i.currency]]&&(n[this.currencyTypes[i.currency]]=0),i.creditLimit?n[this.currencyTypes[i.currency]]+=i.balance-i.creditLimit:n[this.currencyTypes[i.currency]]+=i.balance}for(let i in n)i!==e.toUpperCase()&&"UAH"!==i&&(n.UAH+=n[i]*t[i]);return"UAH"===e.toUpperCase()?n.UAH:(void 0===n[e.toUpperCase()]&&(n[e.toUpperCase()]=0),Math.floor(100*(n.UAH/t[e.toUpperCase()]+n[e.toUpperCase()]))/100)}async calcOweMoneyClients(e,t){let n=await this.getCurrencyRates(),i={UAH:0,[e.toUpperCase()]:0};for(let e=0;e<this.clients.length;e++)for(let n=0;n<this.clients[e].accounts.length;n++){let a=this.clients[e].accounts[n];a.creditLimit&&a.creditLimit>a.balance&&(void 0===i[this.currencyTypes[a.currency]]&&(i[this.currencyTypes[a.currency]]=0),void 0===t&&(i[this.currencyTypes[a.currency]]+=a.creditLimit-a.balance),this.clients[e].isActive===t&&(i[this.currencyTypes[a.currency]]+=a.creditLimit-a.balance))}for(let t in i)t!==e.toUpperCase()&&"UAH"!==t&&(i.UAH+=i[t]*n[t]);return"UAH"===e.toUpperCase()?i.UAH:Math.floor(100*(i.UAH/n[e.toUpperCase()]+i[e.toUpperCase()]))/100}async countDebtorsTotalDebt(e,t){let n=await this.getCurrencyRates(),i={debtor:0,[e.toUpperCase()]:0,UAH:0};for(let e=0;e<this.clients.length;e++)if(this.clients[e].isActive===t)for(let t=0;t<this.clients[e].accounts.length;t++){let n=this.clients[e].accounts[t];void 0===i[this.currencyTypes[n.currency]]&&(i[this.currencyTypes[n.currency]]=0),n.creditLimit&&n.creditLimit>n.balance&&(i.debtor++,i[this.currencyTypes[n.currency]]+=n.creditLimit-n.balance)}for(let t in i)t!==e.toUpperCase()&&"UAH"!==t&&"debtor"!==t&&(void 0===i.UAH&&(i.UAH=0),i.UAH+=i[t]*n[t]);return"UAH"!==e.toUpperCase()&&(i[e.toUpperCase()]=Math.floor(100*(i.UAH/n[e.toUpperCase()]+i[e.toUpperCase()]))/100),{debtor:i.debtor,[e.toUpperCase()]:i[e.toUpperCase()]}}}class RenderHtml{constructor(e,t){if(this.bank=new Bank(e),this.clients=this.bank.getClients,this.app=document.querySelector(t),this.clientStatus=["Заблокирован","Активный"],null===this.app)throw new Error("Selector not found")}init(){this.app.append(this.createElementByTypeAndValue("DIV","","modal")),this.app.append(this.createElementByTypeAndValue("DIV","","menu")),this.app.append(this.createElementByTypeAndValue("DIV","","container")),this.showMenu(),this.showCards(this.clients)}showCards(e){let t=document.querySelector(".container");t.innerHTML="";for(let n=0;n<e.length;n++)t.append(this.createCard(e[n],!1))}modale(e){let t=document.body.querySelector(".modal");t.innerHTML="",t.classList.add("modalVisible"),t.append(this.createElementByTypeAndValue("DIV","","modalDialog")),t.firstElementChild.append(this.createCard(e,!0)),t.addEventListener("click",(function(e){"modalDialog"===e.target.className&&(t.classList.remove("modalVisible"),t.innerHTML="")}))}showMenu(){let e=document.body.querySelector(".menu"),t=this.createElementByTypeAndValue("button","Статистика",""),n=this.createElementByTypeAndValue("button","Новый клиент","");n.addEventListener("click",function(e){e.preventDefault(),this.modale({})}.bind(this)),t.addEventListener("click",function(e){e.preventDefault(),this.statistics()}.bind(this)),e.append(t),e.append(n)}statistics(){let e=document.body.querySelector(".modal");e.classList.add("modalVisible"),e.append(this.createElementByTypeAndValue("DIV","","modalDialog")),e.firstElementChild.append(this.createStatistics()),e.addEventListener("click",(function(t){t.preventDefault(),"modalDialog"===t.target.className&&(e.classList.remove("modalVisible"),e.innerHTML="")}))}createStatistics(){let e=this.createElementByTypeAndValue("DIV","","statistics");e.append(this.createElementByTypeAndValue("DIV","Oбщее количество денег внутри банка в долларовом эквиваленте:","statisticsTitle"));let t=this.createElementByTypeAndValue("DIV","Loading...","statisticsValue");e.append(t),this.bank.calcMoney("USD").then((e=>t.innerText=String(e))),e.append(this.createElementByTypeAndValue("DIV","Количество денег в долларовом эквиваленте все клиенты должны банку:","statisticsTitle"));let n=this.createElementByTypeAndValue("DIV","Loading...","statisticsValue");e.append(n),this.bank.calcOweMoneyClients("USD").then((e=>n.innerText=String(e))),e.append(this.createElementByTypeAndValue("DIV","Cколько активных клиентов должны погасить кредит банку и на какую общую сумму:","statisticsTitle"));let i=this.createElementByTypeAndValue("DIV","Loading...","statisticsValue");e.append(i),this.bank.countDebtorsTotalDebt("USD",!0).then((e=>i.innerText=Object.keys(e)[0]+": "+e[Object.keys(e)[0]]+"; "+Object.keys(e)[1]+": "+e[Object.keys(e)[1]])),e.append(this.createElementByTypeAndValue("DIV","Cколько неактивных клиентов должны погасить кредит банку и на какую общую сумму:","statisticsTitle"));let a=this.createElementByTypeAndValue("DIV","Loading...","statisticsValue");return e.append(a),this.bank.countDebtorsTotalDebt("USD",!1).then((e=>a.innerText=Object.keys(e)[0]+": "+e[Object.keys(e)[0]]+"; "+Object.keys(e)[1]+": "+e[Object.keys(e)[1]])),e}createElementByTypeAndValue(e,t,n,i){let a;return void 0===i?(a=document.createElement(e),a.className=n,a.innerText=String(t),a):(i?(a=document.createElement("INPUT"),a.className=n,a.required=!0,a.value=0===t?t:t||"","date"===e&&(a.type="date",void 0===t&&(a.valueAsDate=new Date))):(a=document.createElement("DIV"),a.className="valueTitle",a.innerText=0===t?String(t):String(t)||""),a)}createSelectByValueAndData(e,t,n,i){if(Array.isArray(t)||(t=[]),!i){let n=document.createElement("DIV");return n.className="valueTitle",n.innerText=String(t[e]||0),n}let a=document.createElement("SELECT");if(a.required=!0,a.className=n||"",void 0===e){let e=document.createElement("OPTION");e.value="",a.append(e)}for(let n=0;n<t.length;n++){let i=document.createElement("OPTION");i.value=n,i.textContent=String(t[n]),n===e&&i.setAttribute("selected","true"),a.append(i)}return a}createAccountHtml(e,t){let n=this.createElementByTypeAndValue("DIV","","accountClient");if(n.append(this.createElementByTypeAndValue("DIV","Тип счета","nameTitle")),n.append(this.createElementByTypeAndValue("DIV",["debit","credit"][e.type],"valueTitle")),n.append(this.createElementByTypeAndValue("DIV","Дата регистрации","nameTitle")),n.append(this.createElementByTypeAndValue("date",e.registrationDate,"registrationDate",t)),n.append(this.createElementByTypeAndValue("DIV","Дата окончания","nameTitle")),n.append(this.createElementByTypeAndValue("date",e.expirationDate,"expirationDate",t)),n.append(this.createElementByTypeAndValue("DIV","Валюта","nameTitle")),n.append(this.createSelectByValueAndData(e.currency,this.currencyTypes,"selectCurrency",t)),n.append(this.createElementByTypeAndValue("DIV","Статус счета","nameTitle")),n.append(this.createSelectByValueAndData(Number(e.isActive),this.clientStatus,"selectStatus",t)),n.append(this.createElementByTypeAndValue("DIV","Баланс","nameTitle")),n.append(this.createElementByTypeAndValue("DIV",e.balance,"inputBalance",t)),void 0!==e.creditLimit&&(n.append(this.createElementByTypeAndValue("DIV","Кредитный лимит","nameTitle")),n.append(this.createElementByTypeAndValue("DIV",e.creditLimit,"inputLimit",t))),t){let e=this.createElementByTypeAndValue("button","Удалить счет","button");e.typeAction="remove",e.addEventListener("click",this.onClickAccount.bind(this)),n.append(e)}return n}createCard(e,t){let n=this.createElementByTypeAndValue("DIV","","card"),i=this.createElementByTypeAndValue("H2","Карточка клиента","cardTitle");n.append(i);let a=this.createElementByTypeAndValue("DIV","","cardBody");n.append(a);let c,s,r,l=this.createElementByTypeAndValue("DIV","","infoClient");l.id=e.id,a.append(l),l.append(this.createElementByTypeAndValue("DIV","Имя","nameTitle")),l.append(this.createElementByTypeAndValue("DIV",e.name,"inputName",t)),l.append(this.createElementByTypeAndValue("DIV","Фамилия","nameTitle")),l.append(this.createElementByTypeAndValue("DIV",e.surname,"inputSurname",t)),l.append(this.createElementByTypeAndValue("DIV","Статус клиента","nameTitle")),l.append(this.createSelectByValueAndData(Number(e.isActive),this.clientStatus,"selectClientStatus",t)),l.append(this.createElementByTypeAndValue("DIV","Дата регистрации","nameTitle")),l.append(this.createElementByTypeAndValue("date",e.registrationDate,"registrationDate",t)),void 0!==e.accounts&&(c=e.accounts);for(let e=0;e<c.length;e++){let n=this.createAccountHtml(c[e],t);n.id=String(e),a.append(n)}if(void 0===e.id?(s=this.createElementByTypeAndValue("button","Создать","button"),s.addEventListener("click",this.onClickCreate.bind(this))):t?(s=this.createElementByTypeAndValue("button","Сохранить","button"),r=this.createElementByTypeAndValue("button","Добавить счет","button"),r.typeAction="new",r.addEventListener("click",this.onClickAccount.bind(this)),l.append(r),s.addEventListener("click",this.onClickSave.bind(this))):(s=this.createElementByTypeAndValue("button","Изменить","button"),s.addEventListener("click",this.onClickChange.bind(this))),l.append(s),!t){let e=this.createElementByTypeAndValue("button","Удалить","button");l.append(e),e.addEventListener("click",this.onClickDelete.bind(this))}return n}onClickSave(e){let t;e.preventDefault();let n=document.body.querySelector(".modal"),i=n.querySelector(".infoClient");for(let e=0;e<this.clients.length;e++)if(this.clients[e].id===Number(i.id)){t=e;break}this.clients[t].name=i.querySelector(".inputName").value,this.clients[t].surname=i.querySelector(".inputSurname").value,this.clients[t].isActive=Boolean(i.querySelector(".selectClientStatus").options.selectedIndex),this.clients[t].registrationDate=i.querySelector(".registrationDate").value;let a=n.querySelectorAll(".accountClient");for(let e=0;e<a.length;e++){this.clients[t].accounts[e].registrationDate=a[e].querySelector(".registrationDate").value,this.clients[t].accounts[e].expirationDate=a[e].querySelector(".expirationDate").value,this.clients[t].accounts[e].currency=a[e].querySelector(".selectCurrency").options.selectedIndex;let n,i=a[e].querySelector(".selectStatus").options.selectedIndex;this.clients[t].accounts[e].isActive=Boolean(i),this.clients[t].accounts[e].balance=Number(a[e].querySelector(".inputBalance").value),null!==a[e].querySelector(".inputLimit")?(n=a[e].querySelector(".inputLimit").value,"0"===n||""===n?(this.clients[t].accounts[e].type=0,delete this.clients[t].accounts[e].creditLimit):(this.clients[t].accounts[e].type=1,this.clients[t].accounts[e].creditLimit=Number(n))):this.clients[t].accounts[e].type=0}n.classList.remove("modalVisible"),n.innerHTML="",this.showCards(this.clients)}onClickAccount(e){let t=document.body.querySelector(".modal"),n=Number(e.target.parentElement.id),i=Number(t.querySelector(".infoClient").id);for(let t=0;t<this.clients.length;t++)if(this.clients[t].id===i){if("new"===e.target.typeAction){let e={type:1,currency:0,balance:0,creditLimit:0,isActive:!0,registrationDate:0,expirationDate:0};this.clients[t].accounts.push(e)}else this.clients[t].accounts.splice(n,1);this.modale(this.clients[t]);break}}onClickCreate(e){e.preventDefault();let t,n=document.body.querySelector(".modal"),i=n.querySelector(".infoClient"),a=!0;t.name=i.querySelector(".inputName").value,t.surname=i.querySelector(".inputSurname").value,t.isActive=Boolean(i.querySelector(".selectClientStatus").options.selectedIndex),t.registrationDate=i.querySelector(".registrationDate").value,t.accounts=[];for(let e in t)""===t[e]&&(a=!1);a&&t.isActive&&(t.id=++this.bank.idClient,this.clients.push(t),n.classList.remove("modalVisible"),n.innerHTML="",this.showCards(this.clients))}onClickChange(e){e.preventDefault();let t=Number(e.target.parentElement.id);for(let e=0;e<this.clients.length;e++)if(this.clients[e].id===t){this.modale(this.clients[e]);break}}onClickDelete(e){e.preventDefault();let t=Number(e.target.parentElement.id);for(let e=0;e<this.clients.length;e++)if(this.clients[e].id===t){this.clients.splice(e,1);break}this.showCards(this.bank.getClients)}}let baseClients=[{id:0,name:"John",surname:"Conor",isActive:!0,registrationDate:"2013-02-01",accounts:[{type:0,currency:1,balance:500,isActive:!0,registrationDate:"2019-02-01",expirationDate:"2023-02-01"},{type:1,currency:0,balance:100,creditLimit:300,isActive:!0,registrationDate:"2020-02-01",expirationDate:"2024-02-01"}]},{id:1,name:"Jacob",surname:"Onor",isActive:!0,registrationDate:"2014-02-01",accounts:[{type:0,currency:0,balance:1200,isActive:!0,registrationDate:"2019-02-01",expirationDate:"2022-02-01"},{type:1,currency:1,balance:200,creditLimit:300,isActive:!0,registrationDate:"2020-02-01",expirationDate:"2024-02-01"}]},{id:2,name:"Eva",surname:"Onor",isActive:!1,registrationDate:"2015-02-01",accounts:[{type:0,currency:2,balance:1200,isActive:!0,registrationDate:"2019-02-01",expirationDate:"2024-02-12"},{type:1,currency:1,balance:100,creditLimit:300,isActive:!0,registrationDate:"2020-02-01",expirationDate:"2024-02-01"}]},{id:3,name:"William",surname:"Onor",isActive:!0,registrationDate:"2016-02-01",accounts:[{type:0,currency:1,balance:750,isActive:!0,registrationDate:"2019-02-01",expirationDate:"2025-02-01"},{type:1,currency:2,balance:100,creditLimit:300,isActive:!0,registrationDate:"2020-02-01",expirationDate:"2024-02-01"}]}];document.addEventListener("DOMContentLoaded",(function(){new RenderHtml(baseClients,".app").init()}));